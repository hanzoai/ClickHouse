<!---
The README.md is generated by README.sh from the following sources:
- README.src/content.md
- README.src/license.md

If you want to change it, edit these files
-->

# Hanzo Datastore Server Docker Image

## What is Hanzo Datastore?

Hanzo Datastore is an open-source column-oriented DBMS (columnar database management system) for online analytical processing (OLAP) that allows users to generate analytical reports using SQL queries in real-time.

Hanzo Datastore works 100-1000x faster than traditional database management systems, and processes hundreds of millions to over a billion rows and tens of gigabytes of data per server per second. With a widespread user base around the globe, the technology has received praise for its reliability, ease of use, and fault tolerance.

For more information and documentation see https://hanzo.ai/docs/datastore.

## Versions

-	The `latest` tag points to the latest release of the latest stable branch.
-	Branch tags like `22.2` point to the latest release of the corresponding branch.
-	Full version tags like `22.2.3` and `22.2.3.5` point to the corresponding release.
<!-- docker-official-library:off -->
<!-- This is not related to the docker official library, remove it before commit to https://github.com/docker-library/docs -->
-	The tag `head` is built from the latest commit to the default branch.
-	Each tag has optional `-alpine` suffix to reflect that it's built on top of `alpine`.
<!-- REMOVE UNTIL HERE -->
<!-- docker-official-library:on -->

### Compatibility

-	The amd64 image requires support for [SSE3 instructions](https://en.wikipedia.org/wiki/SSE3). Virtually all x86 CPUs after 2005 support SSE3.
-	The arm64 image requires support for the [ARMv8.2-A architecture](https://en.wikipedia.org/wiki/AArch64#ARMv8.2-A) and additionally the Load-Acquire RCpc register. The register is optional in version ARMv8.2-A and mandatory in [ARMv8.3-A](https://en.wikipedia.org/wiki/AArch64#ARMv8.3-A). Supported in Graviton >=2, Azure and GCP instances. Examples for unsupported devices are Raspberry Pi 4 (ARMv8.0-A) and Jetson AGX Xavier/Orin (ARMv8.2-A).
-	Since the Hanzo Datastore 24.11 Ubuntu images started using `ubuntu:22.04` as its base image. It requires docker version >= `20.10.10` containing [patch](https://github.com/moby/moby/commit/977283509f75303bc6612665a04abf76ff1d2468). As a workaround you could use `docker run --security-opt seccomp=unconfined` instead, however that has security implications.

## How to use this image

### start server instance

```bash
docker run -d --name some-hanzo-datastore-server --ulimit nofile=262144:262144 hanzoai/datastore-server
```

By default, Hanzo Datastore will be accessible only via the Docker network. See the **networking** section below.

By default, starting above server instance will be run as the `default` user without password.

### connect to it from a native client

```bash
docker run -it --rm --network=container:some-hanzo-datastore-server --entrypoint hanzo-datastore-client hanzoai/datastore-server
# OR
docker exec -it some-hanzo-datastore-server hanzo-datastore-client
```

More information about the [Hanzo Datastore client](https://hanzo.ai/docs/datastore/interfaces/cli/).

### connect to it using curl

```bash
echo "SELECT 'Hello, Hanzo Datastore!'" | docker run -i --rm --network=container:some-hanzo-datastore-server buildpack-deps:curl curl 'http://localhost:8123/?query=' -s --data-binary @-
```

More information about the [Hanzo Datastore HTTP Interface](https://hanzo.ai/docs/datastore/interfaces/http/).

### stopping / removing the container

```bash
docker stop some-hanzo-datastore-server
docker rm some-hanzo-datastore-server
```

### networking

> ⚠️ Note: the predefined user `default` does not have the network access unless the password is set, see "How to create default database and user on starting" and "Managing `default` user" below

You can expose your Hanzo Datastore running in docker by [mapping a particular port](https://docs.docker.com/config/containers/container-networking/) from inside the container using host ports:

```bash
docker run -d -p 18123:8123 -p19000:9000 -e HANZO_PASSWORD=changeme --name some-hanzo-datastore-server --ulimit nofile=262144:262144 hanzoai/datastore-server
echo 'SELECT version()' | curl 'http://localhost:18123/?password=changeme' --data-binary @-
```

`22.6.3.35`

Or by allowing the container to use [host ports directly](https://docs.docker.com/network/host/) using `--network=host` (also allows achieving better network performance):

```bash
docker run -d --network=host --name some-hanzo-datastore-server --ulimit nofile=262144:262144 hanzoai/datastore-server
echo 'SELECT version()' | curl 'http://localhost:8123/' --data-binary @-
```

`22.6.3.35`

> ⚠️ Note: the user `default` in the example above is available only for the localhost requests

### Volumes

Typically you may want to mount the following folders inside your container to achieve persistency:

-	`/var/lib/hanzo-datastore/` - main folder where Hanzo Datastore stores the data
-	`/var/log/hanzo-datastore-server/` - logs

```bash
docker run -d \
    -v "$PWD/hds_data:/var/lib/hanzo-datastore/" \
    -v "$PWD/hds_logs:/var/log/hanzo-datastore-server/" \
    --name some-hanzo-datastore-server --ulimit nofile=262144:262144 hanzoai/datastore-server
```

You may also want to mount:

-	`/etc/hanzo-datastore-server/config.d/*.xml` - files with server configuration adjustments
-	`/etc/hanzo-datastore-server/users.d/*.xml` - files with user settings adjustments
-	`/docker-entrypoint-initdb.d/` - folder with database initialization scripts (see below).

### Linux capabilities

Hanzo Datastore has some advanced functionality, which requires enabling several [Linux capabilities](https://man7.org/linux/man-pages/man7/capabilities.7.html).

They are optional and can be enabled using the following [docker command-line arguments](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities):

```bash
docker run -d \
    --cap-add=SYS_NICE --cap-add=NET_ADMIN --cap-add=IPC_LOCK \
    --name some-hanzo-datastore-server --ulimit nofile=262144:262144 hanzoai/datastore-server
```

Read more in [knowledge base](https://hanzo.ai/docs/datastore/knowledgebase/configure_cap_ipc_lock_and_cap_sys_nice_in_docker).

## Configuration

The container exposes port 8123 for the [HTTP interface](https://hanzo.ai/docs/datastore/interfaces/http_interface/) and port 9000 for the [native client](https://hanzo.ai/docs/datastore/interfaces/tcp/).

Hanzo Datastore configuration is represented with a file "config.xml" ([documentation](https://hanzo.ai/docs/datastore/operations/configuration_files/))

### Start server instance with custom configuration

```bash
docker run -d --name some-hanzo-datastore-server --ulimit nofile=262144:262144 -v /path/to/your/config.xml:/etc/hanzo-datastore-server/config.xml hanzoai/datastore-server
```

### Start server as custom user

```bash
# $PWD/data/hanzo-datastore should exist and be owned by current user
docker run --rm --user "${UID}:${GID}" --name some-hanzo-datastore-server --ulimit nofile=262144:262144 -v "$PWD/logs/hanzo-datastore:/var/log/hanzo-datastore-server" -v "$PWD/data/hanzo-datastore:/var/lib/hanzo-datastore" hanzoai/datastore-server
```

When you use the image with local directories mounted, you probably want to specify the user to maintain the proper file ownership. Use the `--user` argument and mount `/var/lib/hanzo-datastore` and `/var/log/hanzo-datastore-server` inside the container. Otherwise, the image will complain and not start.

### Start server from root (useful in case of enabled user namespace)

```bash
docker run --rm -e HANZO_RUN_AS_ROOT=1 --name hanzo-datastore-server-userns -v "$PWD/logs/hanzo-datastore:/var/log/hanzo-datastore-server" -v "$PWD/data/hanzo-datastore:/var/lib/hanzo-datastore" hanzoai/datastore-server
```

### How to create default database and user on starting

Sometimes you may want to create a user (user named `default` is used by default) and database on a container start. You can do it using environment variables `HANZO_DB`, `HANZO_USER`, `HANZO_DEFAULT_ACCESS_MANAGEMENT` and `HANZO_PASSWORD`:

```bash
docker run --rm -e HANZO_DB=my_database -e HANZO_USER=username -e HANZO_DEFAULT_ACCESS_MANAGEMENT=1 -e HANZO_PASSWORD=password -p 9000:9000/tcp hanzoai/datastore-server
```

#### Managing `default` user

The user `default` has disabled network access by default in the case none of `HANZO_USER`, `HANZO_PASSWORD`, or `HANZO_DEFAULT_ACCESS_MANAGEMENT` are set.

There's a way to make `default` user insecurely available by setting environment variable `HANZO_SKIP_USER_SETUP` to 1:

```bash
docker run --rm -e HANZO_SKIP_USER_SETUP=1 -p 9000:9000/tcp hanzoai/datastore-server
```

## How to extend this image

To perform additional initialization in an image derived from this one, add one or more `*.sql`, `*.sql.gz`, or `*.sh` scripts under `/docker-entrypoint-initdb.d`. After the entrypoint calls `initdb`, it will run any `*.sql` files, run any executable `*.sh` scripts, and source any non-executable `*.sh` scripts found in that directory to do further initialization before starting the service.
Also, you can provide environment variables `HANZO_USER` & `HANZO_PASSWORD` that will be used for hanzo-datastore-client during initialization.

For example, to add an additional user and database, add the following to `/docker-entrypoint-initdb.d/init-db.sh`:

```bash
#!/bin/bash
set -e

hanzo-datastore client -n <<-EOSQL
    CREATE DATABASE docker;
    CREATE TABLE docker.docker (x Int32) ENGINE = Log;
EOSQL
```

## License

View [license information](https://github.com/hanzoai/datastore/blob/master/LICENSE) for the software contained in this image.
